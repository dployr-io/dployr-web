name: release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build dployr-web
        run: pnpm run build
        env:
          VITE_APP_VERSION: ${{ github.ref_name }}
          VITE_BASE_URL: https://base.dployr.io

      - name: Pack static bundle
        run: |
          TAG="${{ github.ref_name }}"
          TARBALL="dployr-web-${TAG}.tar.gz"
          mkdir -p artifacts
          tar -czf "artifacts/${TARBALL}" -C dist .
          echo "TARBALL=artifacts/${TARBALL}" >> "$GITHUB_ENV"

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)")
          fi
          
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release and upload tarball
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: ${{ env.TARBALL }}
          generate_release_notes: true
          body: ${{ steps.changelog.outputs.CHANGELOG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/dployr-io/dployr-web:${{ github.ref_name }}
            ghcr.io/dployr-io/dployr-web:latest

      - name: Create discord payload
        run: |
          touch release-update.json
          cat <<EOF > release-update.json
          {
            "content": "Dployr Web ${{ github.ref_name }} has been released!",
            "embeds": [
              {
                "title": "Release ${{ github.ref_name }} is Live!",
                "description": "A new version of dployr web is ready.\n\nView the full changelog and assets below.\n\n[Release details](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})",
                "url": "https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}",
                "color": 5814783,
                "fields": [
                  {
                    "name": "Repository",
                    "value": "[${{ github.repository }}](https://github.com/${{ github.repository }})",
                    "inline": true
                  },
                  {
                    "name": "Tag",
                    "value": "${{ github.ref_name }}",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "Triggered by ${{ github.actor }}"
                },
                "timestamp": "${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}"
              }
            ]
          }
          EOF

      - name: Send discord message via webhook
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.WEBHOOK_URL }}
          raw-data: release-update.json

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=dployr-web --branch=main --commit-dirty=true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
